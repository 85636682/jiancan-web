<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0">
    <title><%= @shop.blank? ? "简餐" : @shop.name %></title>
    <link rel="stylesheet" href="https://res.wx.qq.com/open/libs/weui/0.3.0/weui.min.css"/>
    <%= stylesheet_link_tag 'weui-rails', media: 'all' %>
    <%= javascript_include_tag 'wechat' %>
</head>
<body>
  <div id="app">
    <div class="page">
      <%= yield %>
      <div class="fd">

      </div>
      <div class="weui_extra_area">
        <a href="http://www.jiancan.me">© 简餐网</a>
      </div>
    </div>
  </div>
  <% sign_package = @wechat_client.get_jssign_package(request.url) %>
  <%= javascript_include_tag '//res.wx.qq.com/open/js/jweixin-1.0.0.js' %>
  <script>
    wx.config({
      debug: true,
      appId: "<%= sign_package['appId'] %>",
      timestamp: "<%= sign_package['timestamp'] %>",
      nonceStr: "<%= sign_package['nonceStr'] %>",
      signature: "<%= sign_package['signature'] %>",
      jsApiList: [
        'onMenuShareTimeline',
        'onMenuShareAppMessage'
      ]
    });
    wx.ready(function () {
      wx.checkJsApi({
        jsApiList: [
          'onMenuShareTimeline',,
          'onMenuShareAppMessage'
        ]
      });
    });
    wx.error(function (res) {
      alert('wx.error: '+JSON.stringify(res));
    });
    var app = new Vue({
      el: '#app',
      data: {
        user: {
          mobile: "<%= @user.mobile if @user.mobile.present? %>",
          access_token: "<%= @user.private_token %>",
          likes: <%= @activity_user.present? ? @activity_user.likes.to_i : 0 %>
        },
        target_user: {
          likes: <%= @activity_target_user.present? ? @activity_target_user.likes : 0 %>
        }
      },
      methods: {
        like: function() {
          alert("click a like!");
          $.ajax({
            type: 'PUT',
            url: 'http://www.jiancan.me/api/u1/activities/likes.json',
            data: {
              user_id: <%= @target_user.present? ? @target_user.id : 0 %>,
              activity_id: <%= @activity.id %>,
              access_token: this.user.access_token
            },
            success: function(data){
              console.log(data);
            },
            error: function(xhr, type){
              alert("网络错误！");
            }
          });
        },
        share: function() {
          var mask = $('#mask');
          var weuiActionsheet = $('#weui_actionsheet');
          weuiActionsheet.addClass('weui_actionsheet_toggle');
          mask.show().addClass('weui_fade_toggle').one('click', function () {
            hideActionSheet(weuiActionsheet, mask);
          });
          $('#actionsheet_cancel').one('click', function () {
            hideActionSheet(weuiActionsheet, mask);
          });
          weuiActionsheet.unbind('transitionend').unbind('webkitTransitionEnd');

          function hideActionSheet(weuiActionsheet, mask) {
            weuiActionsheet.removeClass('weui_actionsheet_toggle');
            mask.removeClass('weui_fade_toggle');
            weuiActionsheet.on('transitionend', function () {
              mask.hide();
            }).on('webkitTransitionEnd', function () {
              mask.hide();
            })
          }
        },
        shareFriend: function() {
          alert("shareFriend");
          wx.onMenuShareAppMessage({
            title: '<%= @activity.title %>', // 分享标题
            desc: '', // 分享描述
            link: 'http://jiancan.me/wechat/activity?activity_id=<%= @activity.id %>&target_user_id=<%= @user.id %>', // 分享链接
            imgUrl: '', // 分享图标
            type: '', // 分享类型,music、video或link，不填默认为link
            dataUrl: '', // 如果type是music或video，则要提供数据链接，默认为空
            success: function () {
                // 用户确认分享后执行的回调函数
            },
            cancel: function () {
                // 用户取消分享后执行的回调函数
            }
          });
        },
        shareFriends: function() {
          alert("shareFriends");
          wx.onMenuShareTimeline({
            title: '<%= @activity.title %>',  // 分享标题
            link: 'http://jiancan.me/wechat/activity?activity_id=<%= @activity.id %>&target_user_id=<%= @user.id %>',   // 分享链接
            imgUrl: '', // 分享图标
            success: function () {
                // 用户确认分享后执行的回调函数
            },
            cancel: function () {
                // 用户取消分享后执行的回调函数
            }
          });
        },
        binding: function() {
          $.ajax({
            type: 'PUT',
            url: 'http://www.jiancan.me/api/u1/users/current.json',
            data: {
              user: {
                mobile: this.user.mobile
              },
              access_token: this.user.access_token
            },
            success: function(data){
              console.log(data);
            },
            error: function(xhr, type){
              alert("网络错误！");
            }
          });
        }
      },
      ready: function() {
      }
    })
  </script>
</body>
</html>
