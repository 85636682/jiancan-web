<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0">
    <title><%= @shop.blank? ? "简餐" : @shop.name %></title>
    <link rel="stylesheet" href="https://res.wx.qq.com/open/libs/weui/0.3.0/weui.min.css"/>
    <%= stylesheet_link_tag 'weui-rails', media: 'all' %>
    <script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js" charset="utf-8"></script>
    <script src="http://res.wx.qq.com/open/js/jweixin-1.1.0.js" charset="utf-8"></script>
    <%= javascript_include_tag 'wechat' %>
</head>
<body>
  <div id="app">
    <div class="page">
      <%= yield %>
      <div class="fd">

      </div>
      <div class="weui_extra_area">
        <a href="http://www.jiancan.me">© 简餐网</a>
      </div>
    </div>
  </div>
  <% sign_package = @weixin_client.get_jssign_package(request.url) %>
  <script>
    wx.config({
      debug: false,
      appId: "<%= sign_package['appId'] %>",
      timestamp: "<%= sign_package['timestamp'] %>",
      nonceStr: "<%= sign_package['nonceStr'] %>",
      signature: "<%= sign_package['signature'] %>",
      jsApiList: [
        'onMenuShareTimeline',
        'onMenuShareAppMessage',
        'onMenuShareQQ',
        'onMenuShareWeibo',
        'hideMenuItems',
        'showMenuItems',
        'hideAllNonBaseMenuItem',
        'showAllNonBaseMenuItem',
        'translateVoice',
        'startRecord',
        'stopRecord',
        'onRecordEnd',
        'playVoice',
        'pauseVoice',
        'stopVoice',
        'uploadVoice',
        'downloadVoice',
        'chooseImage',
        'previewImage',
        'uploadImage',
        'downloadImage',
        'getNetworkType',
        'openLocation',
        'getLocation',
        'hideOptionMenu',
        'showOptionMenu',
        'closeWindow',
        'scanQRCode',
        'chooseWXPay',
        'openProductSpecificView',
        'addCard',
        'chooseCard',
        'openCard'
      ]
    });
    var app = new Vue({
      el: '#app',
      data: {
        user: {
          mobile: "<%= @user.mobile if @user.mobile.present? %>",
          access_token: "<%= @user.private_token %>",
          likes: ""
        }
      },
      methods: {
        like: function() {
          alert("click a like!");
        },
        share: function() {
          var mask = $('#mask');
          var weuiActionsheet = $('#weui_actionsheet');
          weuiActionsheet.addClass('weui_actionsheet_toggle');
          mask.show().addClass('weui_fade_toggle').one('click', function () {
            hideActionSheet(weuiActionsheet, mask);
          });
          $('#actionsheet_cancel').one('click', function () {
            hideActionSheet(weuiActionsheet, mask);
          });
          weuiActionsheet.unbind('transitionend').unbind('webkitTransitionEnd');

          function hideActionSheet(weuiActionsheet, mask) {
            weuiActionsheet.removeClass('weui_actionsheet_toggle');
            mask.removeClass('weui_fade_toggle');
            weuiActionsheet.on('transitionend', function () {
              mask.hide();
            }).on('webkitTransitionEnd', function () {
              mask.hide();
            })
          }
        },
        binding: function() {
          $.ajax({
            type: 'PUT',
            url: 'http://www.jiancan.me/api/u1/users/current.json',
            data: {
              user: {
                mobile: this.user.mobile
              },
              access_token: this.user.access_token
            },
            success: function(data){
              console.log(data);
            },
            error: function(xhr, type){
              alert("网络错误！");
            }
          });
        }
      },
      ready: function() {
      }
    })
  </script>
</body>
</html>
