<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0">
    <title><%= @shop.blank? ? "简餐" : @shop.name %></title>
    <link rel="stylesheet" href="https://res.wx.qq.com/open/libs/weui/0.3.0/weui.min.css"/>
    <%= stylesheet_link_tag 'weui-rails', media: 'all' %>
    <%= javascript_include_tag 'wechat' %>
</head>
<body>
  <div id="app">
    <div class="page">
      <%= yield %>
      <div class="fd">

      </div>
      <div class="weui_extra_area">
        <a href="http://www.jiancan.me">© 简餐网</a>
      </div>
    </div>
  </div>
  <% sign_package = @wechat_client.get_jssign_package(request.url) %>
  <%= javascript_include_tag '//res.wx.qq.com/open/js/jweixin-1.0.0.js' %>
  <script>
    wx.config({
      debug: false,
      appId: "<%= sign_package['appId'] %>",
      timestamp: "<%= sign_package['timestamp'] %>",
      nonceStr: "<%= sign_package['nonceStr'] %>",
      signature: "<%= sign_package['signature'] %>",
      jsApiList: [
        'onMenuShareTimeline',
        'onMenuShareAppMessage'
      ]
    });
    wx.ready(function () {
      wx.onMenuShareTimeline({
        title: '<%= @activity.title %>',  // 分享标题
        link: 'http://jiancan.me/wechat/activity?activity_id=<%= @activity.id %>&target_user_id=<%= @user.id %>',   // 分享链接
        imgUrl: '', // 分享图标
        success: function () {
          // 用户确认分享后执行的回调函数
        },
        cancel: function () {
          // 用户取消分享后执行的回调函数
        }
      });
      wx.onMenuShareAppMessage({
        title: '<%= @activity.title %>', // 分享标题
        desc: '', // 分享描述
        link: 'http://jiancan.me/wechat/activity?activity_id=<%= @activity.id %>&target_user_id=<%= @user.id %>', // 分享链接
        imgUrl: '', // 分享图标
        type: '', // 分享类型,music、video或link，不填默认为link
        dataUrl: '', // 如果type是music或video，则要提供数据链接，默认为空
        success: function () {
            // 用户确认分享后执行的回调函数
        },
        cancel: function () {
            // 用户取消分享后执行的回调函数
        }
      });
    });
    var app = new Vue({
      el: '#app',
      data: {
        user: {
          mobile: "<%= @user.mobile if @user.mobile.present? %>",
          access_token: "<%= @user.private_token %>",
          likes: <%= @activity_user.present? ? @activity_user.likes.to_i : 0 %>
        },
        target_user: {
          likes: <%= @activity_target_user.present? ? @activity_target_user.likes : 0 %>
        }
      },
      methods: {
        like: function() {
          $.ajax({
            type: 'PUT',
            url: 'http://www.jiancan.me/api/u1/activities/likes.json',
            data: {
              user_id: <%= @target_user.present? ? @target_user.id : 0 %>,
              activity_id: <%= @activity.id %>,
              access_token: app.user.access_token
            },
            success: function(data){
              app.$set("target_user.likes", data.likes);
              alert("点赞成功！");
            },
            error: function(xhr, type){
              var response = JSON.parse(xhr.response);
              alert("网络错误：" + response.error);
            }
          });
        },
        binding: function() {
          if (!app.user.mobile || app.user.mobile === null) {
            alert("电话号码不能为空！");
            return
          }
          $.ajax({
            type: 'PUT',
            url: 'http://www.jiancan.me/api/u1/users/current.json',
            data: {
              user: {
                mobile: app.user.mobile
              },
              access_token: app.user.access_token
            },
            success: function(data){
              app.$set("user.mobile", data.user.mobile);
              alert("绑定成功！");
            },
            error: function(xhr, type){
              var response = JSON.parse(xhr.response);
              alert("网络错误：" + response.error);
            }
          });
        }
      },
      ready: function() {
      }
    })
  </script>
</body>
</html>
